<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Westpine Group Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app-container, #login-page {
            max-width: 90vw;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .slide-content {
            min-height: 500px;
            background-color: #212121;
            border-radius: 8px;
            padding: 24px;
            cursor: text;
        }

        [contenteditable]:focus {
            outline: none;
        }

        .message-bubble {
            background-color: #333;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .own-message {
            background-color: #007bff;
            align-self: flex-end;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4">

    <!-- Login Page -->
    <div id="login-page" class="bg-gray-800 p-8 flex flex-col items-center justify-center space-y-6">
        <h1 class="text-3xl font-bold mb-4">Westpine Group Chat</h1>
        <p class="text-lg text-center">Enter the password to access the group chat and slides.</p>
        <div class="w-full max-w-sm">
            <input id="password-input" type="password" placeholder="Enter Password" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
        </div>
        <button id="login-button" class="w-full max-w-sm p-3 bg-indigo-600 rounded-md font-bold hover:bg-indigo-700 transition duration-200">Enter</button>
        <p id="error-message" class="text-red-500 hidden mt-2"></p>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="hidden bg-gray-800 p-6 flex flex-col h-full space-y-4">
        <header class="flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-700 rounded-lg shadow-lg">
            <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                <h1 class="text-2xl font-bold text-gray-100">Westpine Group Chat</h1>
                <span id="user-id-display" class="text-sm text-gray-400 truncate"></span>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-2 sm:mt-0">
                <button id="view-slides-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">Slides</button>
                <button id="view-chat-button" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition duration-200">Chat</button>
                <button id="view-rules-button" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition duration-200">Rules</button>
            </div>
        </header>

        <!-- Slides View -->
        <div id="slides-view" class="hidden flex-grow flex flex-col space-y-4">
            <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                    <button id="prev-slide-button" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">Previous</button>
                    <button id="next-slide-button" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">Next</button>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="format-help-button" class="px-3 py-1 bg-yellow-600 text-white rounded-lg text-sm hover:bg-yellow-700 transition duration-200">Formatting</button>
                    <div class="text-xl font-bold">
                        Slide <span id="current-slide-number">1</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="add-slide-button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">Add New Slide</button>
                    <button id="delete-slide-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 hidden">Delete Slide</button>
                </div>
            </div>
            <div id="slide-content" contenteditable="true" class="slide-content flex-grow overflow-y-auto focus:ring-2 focus:ring-indigo-500">
                Type your content here...
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="hidden flex-grow flex flex-col justify-between space-y-4">
            <div id="chat-messages" class="flex-grow flex flex-col space-y-4 p-4 overflow-y-auto bg-gray-700 rounded-lg">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                <button id="send-chat-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition duration-200">Send</button>
            </div>
        </div>

        <!-- Rules View -->
        <div id="rules-view" class="hidden flex-grow p-4 bg-gray-700 rounded-lg overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Community Rules</h2>
            <ul class="list-disc list-inside space-y-2">
                <li>Be respectful and kind to all members.</li>
                <li>Keep content appropriate for all ages.</li>
                <li>No spamming or self-promotion.</li>
                <li>Do not share private information.</li>
                <li>Admins reserve the right to remove any content they deem inappropriate.</li>
            </ul>
        </div>
    </div>

    <!-- Modals -->
    <div id="username-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center w-full max-w-sm space-y-4">
            <h3 class="text-2xl font-bold">Choose a Username</h3>
            <p>This will be your name in the chat and on the slides.</p>
            <input id="username-input" type="text" placeholder="Enter Username" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
            <button id="save-username-button" class="w-full p-3 bg-indigo-600 rounded-md font-bold hover:bg-indigo-700 transition duration-200">Save</button>
        </div>
    </div>
    
    <div id="delete-slide-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center w-full max-w-sm space-y-4">
            <h3 class="text-2xl font-bold">Are you sure?</h3>
            <p>This will permanently delete the current slide for all users.</p>
            <div class="flex justify-around">
                <button id="confirm-delete-button" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition duration-200">Delete</button>
                <button id="cancel-delete-button" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 transition duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <div id="format-help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-lg space-y-4">
            <h3 class="text-2xl font-bold text-center">Formatting Help</h3>
            <div class="space-y-4">
                <p>You can use standard HTML tags to format your slide content. Try these:</p>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <code class="block text-sm text-gray-400">&lt;h1&gt;Heading 1&lt;/h1&gt;</code>
                    <code class="block text-sm text-gray-400">&lt;h2&gt;Heading 2&lt;/h2&gt;</code>
                    <code class="block text-sm text-gray-400">&lt;b&gt;Bold Text&lt;/b&gt;</code>
                    <code class="block text-sm text-gray-400">&lt;i&gt;Italic Text&lt;/i&gt;</code>
                    <code class="block text-sm text-gray-400">&lt;p&gt;Paragraph&lt;/p&gt;</code>
                    <code class="block text-sm text-gray-400">&lt;ul&gt;&lt;li&gt;List Item&lt;/li&gt;&lt;/ul&gt;</code>
                </div>
                <p>You can also embed images by pasting the URL directly, like this:</p>
                <code class="block text-sm text-gray-400">&lt;img src="https://example.com/image.jpg" /&gt;</code>
            </div>
            <button id="close-format-modal-button" class="mt-6 w-full p-3 bg-gray-600 rounded-md font-bold hover:bg-gray-700 transition duration-200">Got it!</button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        // Firebase Global Variables (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App State and DOM Elements ---
        let app, db, auth, userId, username, userProfileDocRef, isUserAdmin = false;
        let slides = [{ content: 'Welcome to the first slide!' }];
        let currentSlideIndex = 0;
        let chatMessages = [];
        let viewMode = 'slides'; // 'slides', 'chat', or 'rules'
        let isTyping = false;
        const correctPassword = "msbantonlikesplants"; // Hardcoded password for this demo
        const adminUserIds = ["yN0K5ZJ6wOfo2k4rT2x3y5z7hA1"]; // Replace with actual admin user IDs

        // DOM elements
        const loginPage = document.getElementById('login-page');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const saveUsernameButton = document.getElementById('save-username-button');
        const deleteSlideModal = document.getElementById('delete-slide-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const formatHelpModal = document.getElementById('format-help-modal');
        const closeFormatModalButton = document.getElementById('close-format-modal-button');

        const appContainer = document.getElementById('app-container');
        const viewSlidesButton = document.getElementById('view-slides-button');
        const viewChatButton = document.getElementById('view-chat-button');
        const viewRulesButton = document.getElementById('view-rules-button');
        const slidesView = document.getElementById('slides-view');
        const chatView = document.getElementById('chat-view');
        const rulesView = document.getElementById('rules-view');
        const slideContentDiv = document.getElementById('slide-content');
        const addSlideButton = document.getElementById('add-slide-button');
        const deleteSlideButton = document.getElementById('delete-slide-button');
        const prevSlideButton = document.getElementById('prev-slide-button');
        const nextSlideButton = document.getElementById('next-slide-button');
        const currentSlideNumberSpan = document.getElementById('current-slide-number');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const formatHelpButton = document.getElementById('format-help-button');
        
        // --- Firestore Paths ---
        const getSlidesCollectionRef = () => collection(db, `artifacts/${appId}/public/data/slides`);
        const getChatCollectionRef = () => collection(db, `artifacts/${appId}/public/data/chat`);
        const getUserProfilesCollectionRef = () => collection(db, `artifacts/${appId}/public/data/user_profiles`);
        const getSlideDocRef = (index) => doc(db, `artifacts/${appId}/public/data/slides`, `slide-${index}`);
        const getMessageDocRef = (docId) => doc(db, `artifacts/${appId}/public/data/chat`, docId);

        // --- Functions ---
        const saveSlide = async () => {
            if (!userId) {
                console.error("User not authenticated. Cannot save.");
                return;
            }
            try {
                const docRef = getSlideDocRef(currentSlideIndex);
                await setDoc(docRef, {
                    content: slideContentDiv.innerHTML,
                    index: currentSlideIndex,
                    lastEditor: username || userId
                }, { merge: true });
            } catch (error) {
                console.error("Error saving slide:", error);
            }
        };

        const renderSlide = () => {
            // Only update the slide content if the user is not actively typing
            if (!isTyping) {
                slideContentDiv.innerHTML = slides[currentSlideIndex].content;
            }
            currentSlideNumberSpan.textContent = currentSlideIndex + 1;
        };
        
        const updateUI = () => {
            slidesView.classList.add('hidden');
            chatView.classList.add('hidden');
            rulesView.classList.add('hidden');
            
            viewSlidesButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            viewChatButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            viewRulesButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');

            if (viewMode === 'slides') {
                slidesView.classList.remove('hidden');
                viewSlidesButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                if (isUserAdmin) {
                    deleteSlideButton.classList.remove('hidden');
                }
            } else if (viewMode === 'chat') {
                chatView.classList.remove('hidden');
                viewChatButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else if (viewMode === 'rules') {
                rulesView.classList.remove('hidden');
                viewRulesButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        };

        const renderChat = () => {
            chatMessagesDiv.innerHTML = ''; // Clear existing messages
            chatMessages.forEach(msg => {
                const messageBubble = document.createElement('div');
                const isOwnMessage = msg.userId === userId;
                const senderName = msg.username || msg.userId;
                messageBubble.className = `flex flex-col mb-2 ${isOwnMessage ? 'items-end' : 'items-start'}`;

                // Create the reactions div
                const reactionsDiv = document.createElement('div');
                reactionsDiv.className = 'flex space-x-2 mt-1';
                if (msg.reactions) {
                    for (const emoji in msg.reactions) {
                        const count = msg.reactions[emoji].length;
                        if (count > 0) {
                            const reactionButton = document.createElement('button');
                            reactionButton.className = 'px-2 py-1 bg-gray-600 rounded-full text-xs hover:bg-gray-500 transition duration-200';
                            reactionButton.innerHTML = `${emoji} ${count}`;
                            reactionButton.addEventListener('click', () => toggleReaction(msg.docId, emoji));
                            reactionsDiv.appendChild(reactionButton);
                        }
                    }
                }

                messageBubble.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1">${isOwnMessage ? 'You' : senderName}</div>
                    <div class="message-bubble ${isOwnMessage ? 'own-message' : 'bg-gray-600'}" data-message-id="${msg.docId}">
                        ${msg.text}
                    </div>
                `;
                messageBubble.appendChild(reactionsDiv);
                chatMessagesDiv.appendChild(messageBubble);
            });
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        };

        const sendMessage = async () => {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;
            if (!userId) {
                console.error("User not authenticated. Cannot send message.");
                return;
            }
            try {
                const chatRef = getChatCollectionRef();
                await addDoc(chatRef, {
                    userId: userId,
                    username: username,
                    text: messageText,
                    timestamp: serverTimestamp(),
                    reactions: {} // Initialize reactions
                });
                chatInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
            }
        };

        const toggleReaction = async (docId, emoji) => {
            if (!userId) {
                console.error("User not authenticated. Cannot react.");
                return;
            }
            try {
                const msgDocRef = getMessageDocRef(docId);
                const docSnap = await getDoc(msgDocRef);
                const reactions = docSnap.data().reactions || {};
                const users = reactions[emoji] || [];

                if (users.includes(userId)) {
                    reactions[emoji] = users.filter(id => id !== userId);
                } else {
                    reactions[emoji] = [...users, userId];
                }
                await setDoc(msgDocRef, { reactions }, { merge: true });
            } catch (error) {
                console.error("Error toggling reaction:", error);
            }
        };

        const showConfirmationModal = () => {
            deleteSlideModal.classList.remove('hidden');
        };

        const hideConfirmationModal = () => {
            deleteSlideModal.classList.add('hidden');
        };

        const deleteSlide = async () => {
            hideConfirmationModal();
            if (!isUserAdmin) {
                console.error("User is not an admin.");
                return;
            }
            if (slides.length <= 1) {
                // If only one slide, just clear it
                const docRef = getSlideDocRef(0);
                await setDoc(docRef, { content: '' });
                return;
            }
            const docRefToDelete = getSlideDocRef(currentSlideIndex);
            await deleteDoc(docRefToDelete);

            // Re-index remaining slides
            for (let i = currentSlideIndex + 1; i < slides.length; i++) {
                const oldDocRef = getSlideDocRef(i);
                const newDocRef = getSlideDocRef(i - 1);
                const docSnap = await getDoc(oldDocRef);
                await setDoc(newDocRef, docSnap.data());
                await deleteDoc(oldDocRef);
            }

            // Adjust current slide index
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
            }
            renderSlide();
        };

        // --- Event Listeners ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === correctPassword) {
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                usernameModal.classList.remove('hidden');
            } else {
                errorMessage.textContent = "Incorrect password. Please try again.";
                errorMessage.classList.remove('hidden');
            }
        });

        saveUsernameButton.addEventListener('click', async () => {
            const inputUsername = usernameInput.value.trim();
            if (inputUsername) {
                username = inputUsername;
                usernameModal.classList.add('hidden');
                try {
                    await setDoc(userProfileDocRef, { username });
                    userIdDisplay.textContent = `User: ${username}`;
                } catch (error) {
                    console.error("Error saving username:", error);
                }
            }
        });

        slideContentDiv.addEventListener('focus', () => {
            isTyping = true;
        });
        slideContentDiv.addEventListener('blur', () => {
            isTyping = false;
        });
        
        slideContentDiv.addEventListener('input', () => {
            slides[currentSlideIndex].content = slideContentDiv.innerHTML;
            saveSlide();
        });

        prevSlideButton.addEventListener('click', () => {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                renderSlide();
                saveSlide();
            }
        });

        nextSlideButton.addEventListener('click', () => {
            if (currentSlideIndex < slides.length - 1) {
                currentSlideIndex++;
                renderSlide();
                saveSlide();
            }
        });

        addSlideButton.addEventListener('click', () => {
            const newSlide = { content: '' };
            slides.push(newSlide);
            currentSlideIndex = slides.length - 1;
            renderSlide();
            saveSlide();
        });

        deleteSlideButton.addEventListener('click', showConfirmationModal);
        confirmDeleteButton.addEventListener('click', deleteSlide);
        cancelDeleteButton.addEventListener('click', hideConfirmationModal);

        viewSlidesButton.addEventListener('click', () => {
            viewMode = 'slides';
            updateUI();
        });

        viewChatButton.addEventListener('click', () => {
            viewMode = 'chat';
            updateUI();
        });

        viewRulesButton.addEventListener('click', () => {
            viewMode = 'rules';
            updateUI();
        });

        sendChatButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Add emoji reactions on message click
        chatMessagesDiv.addEventListener('click', (e) => {
            const messageBubble = e.target.closest('.message-bubble');
            if (messageBubble) {
                const messageId = messageBubble.dataset.messageId;
                const emoji = prompt("Enter an emoji to react with (e.g., 👍, ❤️):");
                if (emoji) {
                    toggleReaction(messageId, emoji);
                }
            }
        });

        formatHelpButton.addEventListener('click', () => {
            formatHelpModal.classList.remove('hidden');
        });
        closeFormatModalButton.addEventListener('click', () => {
            formatHelpModal.classList.add('hidden');
        });

        // --- Firebase Initialization and Auth ---
        window.onload = function () {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userProfileDocRef = doc(getUserProfilesCollectionRef(), userId);
                        isUserAdmin = adminUserIds.includes(userId);

                        // Fetch user profile
                        const profileSnap = await getDoc(userProfileDocRef);
                        if (profileSnap.exists()) {
                            username = profileSnap.data().username;
                            userIdDisplay.textContent = `User: ${username}`;
                        } else {
                            // Prompt for username if it doesn't exist
                            usernameModal.classList.remove('hidden');
                        }

                        // Start real-time listeners once authenticated
                        onSnapshot(getSlidesCollectionRef(), (snapshot) => {
                            const fetchedSlides = [];
                            snapshot.forEach(doc => {
                                fetchedSlides.push({ ...doc.data(), docId: doc.id });
                            });
                            fetchedSlides.sort((a, b) => a.index - b.index);
                            slides = fetchedSlides.length > 0 ? fetchedSlides : [{ content: 'Welcome to the first slide!', docId: 'slide-0' }];
                            if (currentSlideIndex >= slides.length) {
                                currentSlideIndex = slides.length - 1;
                            }
                            renderSlide();
                        });

                        onSnapshot(query(getChatCollectionRef(), orderBy('timestamp')), (snapshot) => {
                            chatMessages = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                            renderChat();
                        });
                        
                        updateUI(); // Initial UI update
                    } else {
                        // Sign in anonymously if no token is available
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
            }
        };

    </script>
</body>
</html>
